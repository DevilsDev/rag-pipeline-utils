name: ðŸ§ª Comprehensive Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - performance
          - security
          - property-based
      generate_reports:
        description: 'Generate visual reports'
        required: false
        default: true
        type: boolean
      parallel_jobs:
        description: 'Number of parallel test jobs'
        required: false
        default: '4'
        type: string

env:
  NODE_VERSION: '18'
  FORCE_COLOR: 1
  CI: true

jobs:
  setup:
    name: ðŸ”§ Setup and Validation
    runs-on: ubuntu-latest
    outputs:
      test-matrix: ${{ steps.test-matrix.outputs.matrix }}
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Generate cache key
        id: cache-key
        run: |
          echo "key=node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Validate project structure
        run: |
          echo "ðŸ” Validating project structure..."
          test -f package.json || exit 1
          test -d __tests__ || exit 1
          test -f __tests__/utils/test-helpers.js || exit 1
          test -f __tests__/utils/test-reporter.js || exit 1
          echo "âœ… Project structure validated"

      - name: Generate test matrix
        id: test-matrix
        run: |
          if [ "${{ github.event.inputs.test_type }}" = "all" ] || [ -z "${{ github.event.inputs.test_type }}" ]; then
            matrix='["unit", "integration", "performance", "security", "property-based", "load", "e2e", "compatibility"]'
          else
            matrix='["${{ github.event.inputs.test_type }}"]'
          fi
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: setup
    if: contains(fromJson(needs.setup.outputs.test-matrix), 'unit')
    strategy:
      matrix:
        node-version: ['16', '18', '20']
        test-group: ['plugins', 'streaming', 'cli', 'dag', 'scripts']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests - ${{ matrix.test-group }}
        run: |
          echo "ðŸ§ª Running unit tests for ${{ matrix.test-group }}..."
          npm test -- --testPathPattern="__tests__/unit/${{ matrix.test-group }}" --coverage --coverageDirectory=coverage/${{ matrix.test-group }} --json --outputFile=test-results-${{ matrix.test-group }}-${{ matrix.node-version }}.json
        env:
          NODE_ENV: test

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: unit-test-results-${{ matrix.test-group }}-${{ matrix.node-version }}
          path: |
            test-results-*.json
            coverage/
          retention-days: 7

  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: setup
    if: contains(fromJson(needs.setup.outputs.test-matrix), 'integration')
    strategy:
      matrix:
        test-scenario: ['streaming-pipeline', 'plugin-integration', 'dag-workflows']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests - ${{ matrix.test-scenario }}
        run: |
          echo "ðŸ”— Running integration tests for ${{ matrix.test-scenario }}..."
          npm test -- --testPathPattern="__tests__/integration/${{ matrix.test-scenario }}" --coverage --json --outputFile=integration-results-${{ matrix.test-scenario }}.json
        env:
          NODE_ENV: test

      - name: Upload integration results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-results-${{ matrix.test-scenario }}
          path: integration-results-*.json
          retention-days: 7

  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: setup
    if: contains(fromJson(needs.setup.outputs.test-matrix), 'performance')
    strategy:
      matrix:
        test-type: ['pipeline-performance', 'concurrent-load']
        dataset-size: ['small', 'medium', 'large']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run performance tests
        run: |
          echo "âš¡ Running performance tests: ${{ matrix.test-type }} with ${{ matrix.dataset-size }} dataset..."
          export DATASET_SIZE=${{ matrix.dataset-size }}
          npm test -- --testPathPattern="__tests__/${{ matrix.test-type }}" --json --outputFile=performance-results-${{ matrix.test-type }}-${{ matrix.dataset-size }}.json --testTimeout=300000
        env:
          NODE_ENV: test
          PERFORMANCE_TESTING: true

      - name: Upload performance results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: performance-test-results-${{ matrix.test-type }}-${{ matrix.dataset-size }}
          path: performance-results-*.json
          retention-days: 30

  security-tests:
    name: ðŸ”’ Security Tests
    runs-on: ubuntu-latest
    needs: setup
    if: contains(fromJson(needs.setup.outputs.test-matrix), 'security')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security tests
        run: |
          echo "ðŸ”’ Running security and isolation tests..."
          npm test -- --testPathPattern="__tests__/security" --json --outputFile=security-results.json
        env:
          NODE_ENV: test
          SECURITY_TESTING: true

      - name: Run dependency audit
        run: |
          echo "ðŸ” Running npm audit..."
          npm audit --audit-level=moderate --json > audit-results.json || true

      - name: Upload security results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-test-results
          path: |
            security-results.json
            audit-results.json
          retention-days: 30

  property-based-tests:
    name: ðŸŽ² Property-Based Tests
    runs-on: ubuntu-latest
    needs: setup
    if: contains(fromJson(needs.setup.outputs.test-matrix), 'property-based')
    strategy:
      matrix:
        iterations: [100, 500, 1000]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run property-based tests
        run: |
          echo "ðŸŽ² Running property-based tests with ${{ matrix.iterations }} iterations..."
          export PROPERTY_TEST_ITERATIONS=${{ matrix.iterations }}
          npm test -- --testPathPattern="__tests__/property" --json --outputFile=property-results-${{ matrix.iterations }}.json --testTimeout=600000
        env:
          NODE_ENV: test
          PROPERTY_TESTING: true

      - name: Upload property test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: property-test-results-${{ matrix.iterations }}
          path: property-results-*.json
          retention-days: 7

  compatibility-tests:
    name: ðŸ”„ Compatibility Tests
    runs-on: ${{ matrix.os }}
    needs: setup
    if: contains(fromJson(needs.setup.outputs.test-matrix), 'compatibility')
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['16', '18', '20']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run compatibility tests
        run: |
          echo "ðŸ”„ Running compatibility tests on ${{ matrix.os }} with Node.js ${{ matrix.node-version }}..."
          npm test -- --testPathPattern="__tests__/compatibility" --json --outputFile=compatibility-results-${{ matrix.os }}-${{ matrix.node-version }}.json
        env:
          NODE_ENV: test

      - name: Upload compatibility results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: compatibility-test-results-${{ matrix.os }}-${{ matrix.node-version }}
          path: compatibility-results-*.json
          retention-days: 7

  generate-reports:
    name: ðŸ“Š Generate Test Reports
    runs-on: ubuntu-latest
    needs: [setup, unit-tests, integration-tests, performance-tests, security-tests, property-based-tests, compatibility-tests]
    if: always() && (github.event.inputs.generate_reports == 'true' || github.event.inputs.generate_reports == '')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download all test artifacts
        uses: actions/download-artifact@v3
        with:
          path: test-artifacts

      - name: Generate comprehensive test report
        run: |
          echo "ðŸ“Š Generating comprehensive test reports..."
          node scripts/generate-test-reports.js
        env:
          ARTIFACTS_PATH: test-artifacts
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}

      - name: Upload HTML reports
        uses: actions/upload-artifact@v3
        with:
          name: test-reports-html
          path: test-reports/
          retention-days: 30

      - name: Deploy reports to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./test-reports
          destination_dir: test-reports/${{ github.run_id }}

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              const reportPath = path.join('test-reports', 'summary.json');
              const summary = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              const comment = `## ðŸ§ª Test Results Summary
              
              | Metric | Value |
              |--------|-------|
              | Overall Status | ${summary.overallStatus === 'passed' ? 'âœ… PASSED' : 'âŒ FAILED'} |
              | Total Tests | ${summary.totalTests} |
              | Passed | ${summary.passedTests} |
              | Failed | ${summary.failedTests} |
              | Coverage | ${summary.coverage}% |
              | Duration | ${summary.duration}ms |
              
              ðŸ“Š [View detailed reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not post test summary comment:', error.message);
            }

  notify-results:
    name: ðŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [generate-reports]
    if: always()
    steps:
      - name: Determine overall status
        id: status
        run: |
          if [ "${{ needs.generate-reports.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=All tests passed successfully! âœ…" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Some tests failed. Please check the reports. âŒ" >> $GITHUB_OUTPUT
          fi

      - name: Create status check
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: '${{ steps.status.outputs.status }}',
              target_url: 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}',
              description: '${{ steps.status.outputs.message }}',
              context: 'Comprehensive Test Suite'
            });

      - name: Slack notification
        if: failure() && github.ref == 'refs/heads/main'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#dev-alerts'
          text: |
            ðŸš¨ Test suite failed on main branch!
            
            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            View details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
