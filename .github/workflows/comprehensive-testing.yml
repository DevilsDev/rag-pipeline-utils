name: Comprehensive Testing (Security Hardened)
"on":
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - docs/**
      - "*.md"
      - .github/ISSUE_TEMPLATE/**
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - docs/**
      - "*.md"
      - .github/ISSUE_TEMPLATE/**
  schedule:
    - cron: 0 2 * * *
  workflow_dispatch:
    inputs:
      test_suite:
        description: Test suite to run
        required: false
        default: all
        type: choice
        options:
          - all
          - unit
          - integration
          - performance
          - security
          - compatibility
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}
permissions:
  contents: read
  actions: read
env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"
  FORCE_COLOR: 1
  CI: true
jobs:
  setup:
    name: Setup and Validation
    runs-on: ubuntu-latest
    outputs:
      test-matrix: ${{ steps.test-matrix.outputs.matrix }}
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Generate cache key
        id: cache-key
        run: |
          set -e
          set -o pipefail
          echo "key=node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}" >> "$GITHUB_OUTPUT"
        shell: bash
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            node-modules-${{ runner.os }}-
      - name: Install dependencies
        run: npm ci
        shell: bash
      - name: Validate project structure
        run: |
          set -e
          set -o pipefail
          echo "Validating project structure..."
          test -f package.json || exit 1
          test -d __tests__ || exit 1
          test -f __tests__/utils/test-helpers.js || exit 1
          test -f __tests__/utils/test-reporter.js || exit 1
          echo "Project structure validated"
        shell: bash
      - name: Generate test matrix
        id: test-matrix
        run: |
          set -e
          set -o pipefail
          if [ "${{ github.event.inputs.test_suite }}" = "all" ] || [ -z "${{ github.event.inputs.test_suite }}" ]; then
            matrix='["unit", "integration", "performance", "security", "compatibility"]'
          else
            matrix='["${{ github.event.inputs.test_suite }}"]'
          fi
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"
        shell: bash
    timeout-minutes: 30
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: setup
    if: contains(fromJson(needs.setup.outputs.test-matrix), 'unit')
    strategy:
      matrix:
        node-version:
          - 18
          - 20
          - 22
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci
        shell: bash
      - name: Run unit tests
        run: |
          set -e
          set -o pipefail
          echo "Running unit tests..."
          npm run test:unit
          npm run test:unit:coverage
        shell: bash
      - name: Upload coverage reports
        uses: codecov/codecov-action@015f24e6818733317a2da2edd6290ab26238649a
        if: matrix.node-version == 20
        with:
          file: ./coverage/lcov.info
          flags: unit-tests
          name: unit-tests-coverage
      - name: Upload failure logs
        if: failure()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: unit-test-failure-logs-${{ matrix.node-version }}-${{ github.run_number }}
          path: |
            npm-debug.log*
            .npm/_logs/*
            test-results.xml
            coverage/
          retention-days: 7
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: unit-tests
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: rag_pipeline_test
        options: "--health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5"
        ports:
          - "5432:5432"
      redis:
        image: redis:7-alpine
        options: "--health-cmd \"redis-cli ping\" --health-interval 10s --health-timeout 5s --health-retries 5"
        ports:
          - "6379:6379"
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci
        shell: bash
      - name: Setup test database
        run: |
          set -e
          set -o pipefail
          npm run db:migrate:test
          npm run db:seed:test
        shell: bash
      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/rag_pipeline_test
          REDIS_URL: redis://localhost:6379
        run: |
          set -e
          set -o pipefail
          npm run test:integration
          npm run test:integration:coverage
        shell: bash
      - name: Upload integration test results
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        if: always()
        with:
          name: integration-test-results
          path: |
            test-results/
            coverage/integration/
          retention-days: 30
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: integration-tests
    if: |
      (github.event_name == 'schedule' || github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'performance') &&
      github.actor != 'github-actions[bot]'
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci
        shell: bash
      - name: Run performance benchmarks
        run: |
          set -e
          set -o pipefail
          npm run test:performance
          npm run benchmark:memory
          npm run benchmark:cpu
        shell: bash
      - name: Upload performance results
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        if: always()
        with:
          name: performance-results
          path: |
            benchmark-results/
            performance-reports/
          retention-days: 90
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: setup
    if: contains(fromJson(needs.setup.outputs.test-matrix), 'security')
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci
        shell: bash
      - name: Run security tests
        run: |
          set -e
          set -o pipefail
          npm test -- --testPathPattern="__tests__/security" --json --outputFile=security-results.json
        env:
          NODE_ENV: test
          SECURITY_TESTING: true
        shell: bash
      - name: Run dependency audit
        run: |
          set -e
          set -o pipefail
          npm audit --audit-level=moderate --json > audit-results.json || true
        shell: bash
      - name: Upload security results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-test-results
          path: |
            security-results.json
            audit-results.json
          retention-days: 30
    timeout-minutes: 30
  property-based-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    needs: setup
    if: contains(fromJson(needs.setup.outputs.test-matrix), 'property-based')
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci
        shell: bash
      - name: Run property-based tests
        run: |
          set -e
          set -o pipefail
          npm test -- --testPathPattern="__tests__/property" --json --outputFile=property-results.json --testTimeout=600000
        env:
          NODE_ENV: test
          PROPERTY_TESTING: true
        shell: bash
      - name: Upload property test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: property-test-results
          path: property-results.json
          retention-days: 7
    timeout-minutes: 30
  compatibility-tests:
    name: Compatibility Tests
    runs-on: ${{ matrix.os }}
    needs: setup
    if: contains(fromJson(needs.setup.outputs.test-matrix), 'compatibility')
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
        node-version:
          - 18
          - 20
          - 22
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci
        shell: bash
      - name: Run compatibility tests
        run: |
          set -e
          set -o pipefail
          npm test -- --testPathPattern="__tests__/compatibility" --json --outputFile=compatibility-results-${{ matrix.os }}-${{ matrix.node-version }}.json
        env:
          NODE_ENV: test
        shell: bash
      - name: Upload compatibility results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compatibility-test-results-${{ matrix.os }}-${{ matrix.node-version }}
          path: compatibility-results-*.json
          retention-days: 7
    timeout-minutes: 30
  generate-reports:
    name: Generate Test Reports
    runs-on: ubuntu-latest
    needs:
      - setup
      - unit-tests
      - integration-tests
      - performance-tests
      - security-tests
      - property-based-tests
      - compatibility-tests
    if: always() && (github.event.inputs.generate_reports == 'true' || github.event.inputs.generate_reports == '')
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci
        shell: bash
      - name: Download all test artifacts
        uses: actions/download-artifact@v4
        with:
          path: test-artifacts
      - name: Generate comprehensive test report
        run: |
          set -e
          set -o pipefail
          echo "Generating comprehensive test reports..."
          node scripts/generate-test-reports.js
        env:
          ARTIFACTS_PATH: test-artifacts
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
        shell: bash
      - name: Upload HTML reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-html
          path: test-reports/
          retention-days: 30
      - name: Deploy reports to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@373f7f263a76c20808c831209c920827a82a2847
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./test-reports
          destination_dir: test-reports/${{ github.run_id }}
      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            try {
              const reportPath = path.join('test-reports', 'summary.json');
              const summary = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              const comment = `## ðŸ§ª Test Results Summary
              
              | Metric | Value |
              |--------|-------|
              | Overall Status | ${summary.overallStatus === 'passed' ? 'âœ… PASSED' : 'âŒ FAILED'} |
              | Total Tests | ${summary.totalTests} |
              | Passed | ${summary.passedTests} |
              | Failed | ${summary.failedTests} |
              | Coverage | ${summary.coverage}% |
              | Duration | ${summary.duration}ms |
              
              ðŸ“Š [View detailed reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not post test summary comment:', error.message);
            }
    timeout-minutes: 30
  notify-results:
    name: ðŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs:
      - generate-reports
    if: always()
    steps:
      - name: Determine overall status
        id: status
        run: |
          set -e
          set -o pipefail
          if [ "${{ needs.generate-reports.result }}" = "success" ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "message=All tests passed successfully! " >> "$GITHUB_OUTPUT"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
            echo "message=Some tests failed. Please check the reports. " >> "$GITHUB_OUTPUT"
          fi
        shell: bash
      - name: Create status check
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: '${{ steps.status.outputs.status }}',
              target_url: 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}',
              description: '${{ steps.status.outputs.message }}',
              context: 'Comprehensive Test Suite'
            });
      - name: Slack notification
        if: failure() && github.ref == 'refs/heads/main'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: "#dev-alerts"
          text: |
            ðŸš¨ Test suite failed on main branch!

            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}

            View details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    timeout-minutes: 30
