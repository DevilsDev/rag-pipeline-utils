name: Contract Schema Validation (Security Hardened)
"on":
  push:
    branches:
      - main
      - develop
    paths:
      - src/contracts/**
      - src/plugins/**
      - package.json
    paths-ignore:
      - docs/**
      - "*.md"
      - .github/ISSUE_TEMPLATE/**
  pull_request:
    branches:
      - main
      - develop
    paths:
      - src/contracts/**
      - src/plugins/**
      - package.json
    paths-ignore:
      - docs/**
      - "*.md"
      - .github/ISSUE_TEMPLATE/**
  workflow_dispatch:
    inputs:
      validation_type:
        description: Type of validation to run
        required: true
        type: choice
        options:
          - full-validation
          - breaking-change-check
          - contract-documentation
          - typescript-generation
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}
permissions:
  contents: read
  actions: read
env:
  NODE_VERSION: "20"
  FORCE_COLOR: 1
  CI: true
jobs:
  validate-contracts:
    name: Validate Plugin Contracts
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci
        shell: bash
      - name: Run contract schema validation tests
        run: |
          set -e
          set -o pipefail
          npm test -- __tests__/ci/contract-schema-validation.test.js --verbose
        shell: bash
      - name: Generate contract validation report
        run: |
          set -e
          set -o pipefail
          echo "# Contract Validation Report" > contract-validation-report.md
          echo "" >> contract-validation-report.md
          echo "**Generated:** $(date -u)" >> contract-validation-report.md
          echo "**Commit:** ${{ github.sha }}" >> contract-validation-report.md
          echo "" >> contract-validation-report.md

          # Run validation and capture output
          npm test -- __tests__/ci/contract-schema-validation.test.js --reporter=json > test-results.json || true

          # Parse results and add to report
          if [ -f test-results.json ]; then
            node -e "
              const results = JSON.parse(require('fs').readFileSync('test-results.json', 'utf8'));
              const passed = results.numPassedTests || 0;
              const failed = results.numFailedTests || 0;
              const total = results.numTotalTests || 0;
              
              console.log('## Test Results');
              console.log('');
              console.log('- **Total Tests:** ' + total);
              console.log('- **Passed:** ' + passed);
              console.log('- **Failed:** ' + failed);
              console.log('- **Success Rate:** ' + Math.round((passed/total)*100) + '%');
              console.log('');
              
              if (failed > 0) {
                console.log('## Failed Tests');
                console.log('');
                if (results.testResults) {
                  results.testResults.forEach(suite => {
                    suite.assertionResults.forEach(test => {
                      if (test.status === 'failed') {
                        console.log('- ‚ùå ' + test.title);
                        if (test.failureMessages) {
                          test.failureMessages.forEach(msg => {
                            console.log('  ``"$($1)"``');
                          });
                        }
                      }
                    });
                  });
                }
              }
            " >> contract-validation-report.md
          fi
        shell: bash
      - name: Upload validation report
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: contract-validation-report
          path: contract-validation-report.md
          retention-days: 30
  breaking-change-detection:
    name: Breaking Change Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event.inputs.validation_type == 'breaking-change-check'
    steps:
      - name: Checkout current branch
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          path: current
      - name: Checkout base branch
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          ref: ${{ github.base_ref || 'main' }}
          path: base
      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "20"
      - name: Install dependencies
        run: |
          set -e
          set -o pipefail
          cd current && npm ci
          cd ../base && npm ci
        shell: bash
      - name: Compare contract versions
        run: |
          set -e
          set -o pipefail
          echo "üîç Checking for breaking changes in plugin contracts..."

          # Compare contract files
          cd current

          breaking_changes=0

          for contract_file in src/contracts/*.json; do
            if [ -f "$contract_file" ]; then
              filename=$(basename "$contract_file")
              echo "Checking $filename..."
              
              if [ -f "../base/$contract_file" ]; then
                # Compare versions
                current_version=$(jq -r '.version' "$contract_file")
                base_version=$(jq -r '.version' "../base/$contract_file")
                
                echo "Current version: $current_version"
                echo "Base version: $base_version"
                
                # Use Node.js to compare semantic versions
                version_comparison=$(node -e "
                  const semver = require('semver');
                  const current = '$current_version';
                  const base = '$base_version';
                  
                  if (semver.major(current) > semver.major(base)) {
                    console.log('major_bump');
                  } else if (semver.minor(current) > semver.minor(base)) {
                    console.log('minor_bump');
                  } else if (semver.patch(current) > semver.patch(base)) {
                    console.log('patch_bump');
                  } else {
                    console.log('no_change');
                  }
                ")
                
                # Check for method removals or signature changes
                current_methods=$(jq -r '.methods[].name' "$contract_file" | sort)
                base_methods=$(jq -r '.methods[].name' "../base/$contract_file" | sort)
                
                removed_methods=$(comm -23 <(echo "$base_methods") <(echo "$current_methods"))
                
                if [ -n "$removed_methods" ]; then
                  echo "‚ùå BREAKING CHANGE: Methods removed in $filename:"
                  echo "$removed_methods"
                  breaking_changes=$((breaking_changes + 1))
                fi
                
                # Check for parameter changes in existing methods
                while IFS= read -r method; do
                  if [ -n "$method" ]; then
                    current_params=$(jq -r ".methods[] | select(.name==\"$method\") | .parameters[]?" "$contract_file" 2>/dev/null | sort)
                    base_params=$(jq -r ".methods[] | select(.name==\"$method\") | .parameters[]?" "../base/$contract_file" 2>/dev/null | sort)
                    
                    removed_params=$(comm -23 <(echo "$base_params") <(echo "$current_params"))
                    
                    if [ -n "$removed_params" ]; then
                      echo "‚ùå BREAKING CHANGE: Parameters removed from $method in $filename:"
                      echo "$removed_params"
                      breaking_changes=$((breaking_changes + 1))
                    fi
                  fi
                done <<< "$current_methods"
                
              else
                echo "‚úÖ New contract file: $filename"
              fi
              
              echo "---"
            fi
          done

          if [ $breaking_changes -gt 0 ]; then
            echo "‚ùå $breaking_changes breaking changes detected!"
            exit 1
          else
            echo "‚úÖ No breaking changes detected"
          fi
        shell: bash
      - name: Comment on PR with breaking change analysis
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@35b1cdd1b2c1fc704b1cd442536d6e4b28b2ba4e
        with:
          script: |
            const comment = `## üö® Breaking Changes Detected

            This PR contains breaking changes to plugin contracts that could affect existing implementations.

            ### What are breaking changes?
            - Removing existing methods from contracts
            - Removing required parameters from existing methods
            - Changing return types of existing methods
            - Changing parameter types of existing methods

            ### Next Steps
            1. **If intentional:** Bump the major version in the contract
            2. **If unintentional:** Revert the breaking changes
            3. **Migration needed:** Provide migration guide for plugin developers

            ### Contract Validation
            All contract changes are automatically validated to ensure backward compatibility.

            Please review the changes and update accordingly.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
    timeout-minutes: 30
  generate-documentation:
    name: Generate Contract Documentation
    runs-on: ubuntu-latest
    if: github.event.inputs.validation_type == 'contract-documentation' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "20"
          cache: npm
      - name: Install dependencies
        run: npm ci
        shell: bash
      - name: Generate contract documentation
        run: |
          set -e
          set -o pipefail
          mkdir -p docs/contracts

          # Generate markdown documentation from contracts
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            const contractsDir = 'src/contracts';
            const outputFile = 'docs/contracts/PLUGIN_CONTRACTS.md';
            
            let doc = '# Plugin Contracts\\n\\n';
            doc += 'This document describes the contracts that all plugins must implement.\\n\\n';
            doc += '**Auto-generated from contract schemas**\\n\\n';
            
            if (fs.existsSync(contractsDir)) {
              const files = fs.readdirSync(contractsDir).filter(f => f.endsWith('.json'));
              
              for (const file of files) {
                const contractPath = path.join(contractsDir, file);
                const contract = JSON.parse(fs.readFileSync(contractPath, 'utf8'));
                
                const pluginType = contract.type || file.replace('-contract.json', '');
                doc += \"$($1)";
                doc += \"$($1)";
                
                if (contract.description) {
                  doc += \"$($1)";
                }
                
                if (contract.methods) {
                  doc += '### Methods\\n\\n';
                  
                  for (const method of contract.methods) {
                    doc += \"$($1)";
                    
                    if (method.description) {
                      doc += \"$($1)";
                    }
                    
                    doc += '**Parameters:**\\n\\n';
                    if (Array.isArray(method.parameters)) {
                      for (const param of method.parameters) {
                        if (typeof param === 'string') {
                          doc += \"$($1)";
                        } else {
                          const required = param.required ? '' : ' (optional)';
                          doc += \"$($1)";
                        }
                      }
                    } else {
                      doc += \"$($1)";
                    }
                    
                    doc += '\\n**Returns:**\\n\\n';
                    if (typeof method.returns === 'string') {
                      doc += \"$($1)";
                    } else {
                      doc += \"$($1)";
                      if (method.returns.description) {
                        doc += \"$($1)";
                      }
                      doc += '\\n';
                    }
                  }
                }
                
                doc += '---\\n\\n';
              }
            }
            
            fs.writeFileSync(outputFile, doc);
            console.log('Contract documentation generated: ' + outputFile);
          "
        shell: bash
      - name: Generate TypeScript definitions
        run: |
          set -e
          set -o pipefail
          mkdir -p types

          # Generate TypeScript definitions from contracts
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            const contractsDir = 'src/contracts';
            const outputFile = 'types/plugin-contracts.d.ts';
            
            let typedef = '// Auto-generated TypeScript definitions for plugin contracts\\n\\n';
            
            if (fs.existsSync(contractsDir)) {
              const files = fs.readdirSync(contractsDir).filter(f => f.endsWith('.json'));
              
              for (const file of files) {
                const contractPath = path.join(contractsDir, file);
                const contract = JSON.parse(fs.readFileSync(contractPath, 'utf8'));
                
                const pluginType = contract.type || file.replace('-contract.json', '');
                const interfaceName = \"$($1)";
                
                typedef += \"$($1)";
                
                if (contract.methods) {
                  for (const method of contract.methods) {
                    let params = '';
                    if (Array.isArray(method.parameters)) {
                      params = method.parameters.map(p => {
                        if (typeof p === 'string') {
                          return \"$($1)";
                        } else {
                          const optional = !p.required ? '?' : '';
                          const type = p.type || 'any';
                          return \"$($1)";
                        }
                      }).join(', ');
                    }
                    
                    let returnType = 'any';
                    if (typeof method.returns === 'string') {
                      returnType = method.returns === 'documents' ? 'Document[]' : 
                                  method.returns === 'vector' ? 'number[]' :
                                  method.returns === 'response' ? 'string' : 'any';
                    } else if (method.returns.type) {
                      returnType = method.returns.type === 'array' ? 
                                  \"$($1)" : method.returns.type;
                    }
                    
                    typedef += \"$($1)";
                  }
                }
                
                typedef += '}\\n\\n';
              }
            }
            
            fs.writeFileSync(outputFile, typedef);
            console.log('TypeScript definitions generated: ' + outputFile);
          "
        shell: bash
      - name: Commit generated documentation
        if: github.ref == 'refs/heads/main'
        run: |
          set -e
          set -o pipefail
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if [ -n "$(git status --porcelain)" ]; then
            git add docs/contracts/ types/
            git commit -m "docs: auto-generate contract documentation and TypeScript definitions"
            git push
          else
            echo "No changes to commit"
          fi
        shell: bash
    timeout-minutes: 30
  pre-publish-validation:
    name: Pre-Publish Contract Validation
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "20"
          cache: npm
      - name: Install dependencies
        run: npm ci
        shell: bash
      - name: Validate all contracts before publish
        run: |
          set -e
          set -o pipefail
          echo "üîç Running comprehensive contract validation before publish..."

          # Run all contract validation tests
          npm test -- __tests__/ci/contract-schema-validation.test.js

          # Validate package.json includes contract files
          if ! jq -e '.files[] | select(contains("contracts") or contains("src/contracts"))' package.json > /dev/null; then
            echo "‚ùå Contract files not included in package.json files array"
            exit 1
          fi

          # Validate all plugins have proper metadata
          find src/plugins -name "*.js" -not -path "*/mocks/*" | while read -r plugin_file; do
            if ! grep -q "metadata.*:" "$plugin_file"; then
              echo "‚ùå Plugin missing metadata: $plugin_file"
              exit 1
            fi
          done

          echo "‚úÖ All contract validations passed - ready for publish"
        shell: bash
      - name: Block publish on validation failure
        if: failure()
        run: |
          set -e
          set -o pipefail
          echo "‚ùå Contract validation failed - blocking publish"
          echo "Please fix contract issues before publishing"
          exit 1
        shell: bash
    timeout-minutes: 30
