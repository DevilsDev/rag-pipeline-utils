# .github/workflows/post-release-generate-blog.yml
# Version: 2.2.0
# Description: Auto-generate changelog + blog post from GitHub release or tag
# Author: Ali Kahwaji

name: Auto Generate Blog + Changelog

on:
  release:
    types: [published]     # Trigger when a GitHub release is published
  push:
    tags:
      - 'v*.*.*'            # Also support tag-only releases

permissions:
  contents: write
  issues: write

jobs:
  generate-blog:
    name: ðŸ“˜ Generate Blog Post + Changelog
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“… Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0     # Needed for git tag diffing

      - name: ðŸ›  Setup Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "docs@autobot.local"

      - name: ðŸ“† Get current version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: ðŸ““ Install dependencies
        run: npm ci

      - name: ðŸ”„ Generate blog + changelog
        run: node scripts/generate-release-note.js ${{ steps.version.outputs.tag }}

      - name: ðŸ”’ Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(release): blog + changelog for ${{ steps.version.outputs.tag }}"
          file_pattern: "CHANGELOG.md docs-site/blog/*.md"

      - name: ðŸŒŸ Set success output for badge
        run: echo "blog_generated=true" >> "$GITHUB_OUTPUT"

    outputs:
      blog_generated: true
