name: Auto Generate Blog + Changelog
'on':
  release:
    types:
      - published
  push:
    tags:
      - v*.*.*
  workflow_dispatch:
    inputs:
      dry_run:
        description: Simulate without pushing
        required: false
        default: 'false'
permissions:
  contents: write
  issues: write
  pull-requests: write
jobs:
  generate-blog:
    name: ðŸ““ Generate Blog Post + Changelog
    runs-on: ubuntu-latest
    outputs:
      blog_generated: ${{ steps.output_blog.outputs.blog_generated }}
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: ðŸ›  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      - name: ðŸ”– Detect version
        id: version
        run: |
          echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          echo "dry_run=${{ github.event.inputs.dry_run || 'false' }}" >> "$GITHUB_OUTPUT"
      - name: ðŸ“ Generate release notes
        id: generate_notes
        run: |
          echo "Generating release notes for ${{ steps.version.outputs.tag }}"
          node scripts/generate-release-note.js "${{ steps.version.outputs.tag }}"
        env:
          DRY_RUN: ${{ steps.version.outputs.dry_run }}
      - name: ðŸ”’ Commit generated blog and changelog
        if: steps.version.outputs.dry_run != 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'docs(release): publish blog and changelog for ${{ steps.version.outputs.tag }}'
          file_pattern: CHANGELOG.md docs-site/blog/*.md
      - name: ðŸ’¬ Optionally comment on release
        if: steps.version.outputs.dry_run != 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: 1
          body: ðŸ“ Blog Post + Changelog auto-updated for ${{ steps.version.outputs.tag }} ðŸš€
        continue-on-error: true
      - name: âœ… Output success for badge
        id: output_blog
        run: echo "blog_generated=true" >> "$GITHUB_OUTPUT"
concurrency:
  concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true
