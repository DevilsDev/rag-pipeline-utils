name: Auto Generate Blog + Changelog (Security Hardened)
"on":
  release:
    types:
      - published
  push:
    tags:
      - v*.*.*
  workflow_dispatch:
    inputs:
      dry_run:
        description: Simulate without pushing
        required: false
        default: "false"
permissions:
  contents: read
  actions: read
jobs:
  generate-blog:
    name: ðŸ““ Generate Blog Post + Changelog
    runs-on: ubuntu-latest
    outputs:
      blog_generated: ${{ steps.output_blog.outputs.blog_generated }}
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0
      - name: ðŸ›  Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "20"
      - name: ðŸ“¦ Install dependencies
        run: npm ci
        shell: bash
      - name: ðŸ”– Detect version
        id: version
        run: |
          set -e
          set -o pipefail
          echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          echo "dry_run=${{ github.event.inputs.dry_run || 'false' }}" >> "$GITHUB_OUTPUT"
        shell: bash
      - name: ðŸ“ Generate release notes
        id: generate_notes
        run: |
          set -e
          set -o pipefail
          echo "Generating release notes for ${{ steps.version.outputs.tag }}"
          node scripts/generate-release-note.js "${{ steps.version.outputs.tag }}"
        env:
          DRY_RUN: ${{ steps.version.outputs.dry_run }}
        shell: bash
      - name: ðŸ”’ Commit generated blog and changelog
        if: steps.version.outputs.dry_run != 'true'
        uses: stefanzweifel/git-auto-commit-action@8621497c8c39c72f3e2a999a26b4ca1b5058a842
        with:
          commit_message: "docs(release): publish blog and changelog for ${{ steps.version.outputs.tag }}"
          file_pattern: CHANGELOG.md docs-site/blog/*.md
      - name: ðŸ’¬ Optionally comment on release
        if: steps.version.outputs.dry_run != 'true'
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043
        with:
          issue-number: 1
          body: ðŸ“ Blog Post + Changelog auto-updated for ${{ steps.version.outputs.tag }} ðŸš€
        continue-on-error: true
      - name: âœ… Output success for badge
        id: output_blog
        run: echo "blog_generated=true" >> "$GITHUB_OUTPUT"
        shell: bash
    timeout-minutes: 30
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
