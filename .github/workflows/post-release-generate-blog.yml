# .github/workflows/post-release-generate-blog.yml
# Version: 2.4.0
# Description: Auto-generate blog + changelog from release tags with improved fallback and badge support
# Author: Ali Kahwaji

name: Auto Generate Blog + Changelog

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  issues: write

jobs:
  generate:
    name: Generate Blog Post & Changelog
    runs-on: ubuntu-latest

    outputs:
      blog_generated: ${{ steps.generate.outputs.success == 'true' }}

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required to resolve previous tag history

      - name: 🛠 Configure Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: 📦 Install Node dependencies
        run: npm ci

      - name: 🏷 Determine current version tag
        id: version
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: 📓 Generate Blog + Changelog
        id: generate
        run: |
          echo "🔍 Attempting to generate blog and changelog for ${{ steps.version.outputs.tag }}"
          node scripts/generate-release-note.js "${{ steps.version.outputs.tag }}" || {
            echo "⚠️ No changes or generation failed."
            echo "success=false" >> "$GITHUB_OUTPUT"
            exit 0
          }
          echo "success=true" >> "$GITHUB_OUTPUT"

      - name: 🔐 Commit blog + changelog files
        if: steps.generate.outputs.success == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(release): blog + changelog for ${{ steps.version.outputs.tag }}"
          file_pattern: "CHANGELOG.md docs-site/blog/*.md"
