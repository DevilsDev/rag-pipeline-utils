name: Backfill Releases and News
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  backfill:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - name: Harden runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7
        with:
          egress-policy: audit

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install changelog tooling
        run: |
          npm i -g conventional-changelog-cli@^4.0.0

      - name: Backfill releases and prepare blog posts
        id: prep
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          mkdir -p docs-site/blog
          # list tags without releases
          EXISTING=$(gh release list --repo "$REPO" --limit 1000 --json tagName -q '.[].tagName' || true)
          git tag --list | while read -r TAG; do
            if echo "$EXISTING" | grep -qx "$TAG"; then
              continue
            fi
            # generate simple notes (fallback). If your commit history is conventional, this is decent.
            NOTES="$(conventional-changelog -p angular -r 0 | sed -n '1,120p' || echo "Backfilled release $TAG")"
            gh release create "$TAG" --repo "$REPO" --title "$TAG" --notes "$NOTES"
            TS="$(git log -1 --format=%ad --date=format:%Y-%m-%d "$TAG")"
            SLUG="$(echo "$TAG" | tr -cd '[:alnum:]-._' | tr '[:upper:]' '[:lower:]')"
            FILE="docs-site/blog/${TS}-${SLUG}.md"
            {
              echo "---"
              echo "title: \"$TAG\""
              echo "slug: \"$SLUG\""
              echo "authors: [maintainers]"
              echo "tags: [release]"
              echo "---"
              echo
              echo "$NOTES"
            } > "$FILE"
          done
          echo "changed=$(git status --porcelain | wc -l)" >> $GITHUB_OUTPUT

      - name: Create PR
        if: steps.prep.outputs.changed != '0'
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f
        with:
          commit-message: "docs: backfill release news posts"
          title: "docs: backfill release news posts"
          body: "Auto-generated from historical tags and releases."
          branch: chore/backfill-news
          add-paths: |
            docs-site/blog/**
