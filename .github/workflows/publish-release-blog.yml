# .github/workflows/publish-release-blog.yml
# Version: 1.4.0
# Description: Auto-publish blog post from GitHub Release event with metadata, compare link, and authorship info
# Author: Ali Kahwaji

name: âœ¨ Publish Release Blog Post

on:
  release:
    types: [published]

jobs:
  publish-blog-post:
    name: Generate & Commit Blog Post
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: ðŸ›  Setup GitHub CLI
        uses: cli/cli-action@v2

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: âœï¸ Generate blog post
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          PREV_TAG=$(git tag --sort=creatordate | grep -B1 "$VERSION" | head -n1)
          DATE=$(date +'%Y-%m-%d')
          FILE="docs-site/blog/${DATE}-release-${VERSION}.md"

          COMPARE_URL="https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${VERSION}"
          COMMITS=$(gh api repos/${{ github.repository }}/compare/${PREV_TAG}...${VERSION} --jq '.total_commits')
          CONTRIBUTORS=$(gh api repos/${{ github.repository }}/compare/${PREV_TAG}...${VERSION} --jq '[.commits[].author.login] | unique | join(", ")')

          echo "---" > "$FILE"
          echo "slug: release-${VERSION}" >> "$FILE"
          echo "title: \"âœ¨ Version ${VERSION} Released\"" >> "$FILE"
          echo "authors: [ali]" >> "$FILE"
          echo "tags: [release, changelog]" >> "$FILE"
          echo "---" >> "$FILE"
          echo >> "$FILE"
          echo "ðŸŽ‰ **RAG Pipeline Utils \`${VERSION}\` is now available!**" >> "$FILE"
          echo >> "$FILE"
          echo "## ðŸ” Metadata" >> "$FILE"
          echo "| Key           | Value            |" >> "$FILE"
          echo "|----------------|------------------|" >> "$FILE"
          echo "| Version       | \`${VERSION}\`     |" >> "$FILE"
          echo "| Previous Tag  | \`${PREV_TAG}\`     |" >> "$FILE"
          echo "| Commit Count  | ${COMMITS:-N/A}   |" >> "$FILE"
          echo "| Contributors  | ${CONTRIBUTORS:-N/A} |" >> "$FILE"
          echo "| GitHub Diff   | [${PREV_TAG}...${VERSION}](${COMPARE_URL}) |" >> "$FILE"
          echo >> "$FILE"
          echo "## ðŸš€ Highlights" >> "$FILE"
          echo "- Auto-published blog post from GitHub Release" >> "$FILE"
          echo "- GitHub diff for full history: [${COMPARE_URL}](${COMPARE_URL})" >> "$FILE"
          echo "- Semantic versioning with changelog tracking" >> "$FILE"
          echo "- See full [CHANGELOG.md](../../CHANGELOG.md)" >> "$FILE"

      - name: ðŸ“‹ Commit blog post
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(blog): add release post for ${{ github.ref_name }}"
          file_pattern: "docs-site/blog/*.md"
